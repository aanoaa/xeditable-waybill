// Generated by CoffeeScript 1.8.0

/*
<a href="#" id="waybill" data-type="waybill" data-name="key">awesome</a>
<script>
  $('#waybill').editable
    source: [
      {value:1, text: 'Fedex'},
      {value:2, text: 'DHL'}
    ]
    value:
      parcel: 'Fedex'
      number: '123456'
</script>
 */
var Waybill;

Waybill = function(opts) {
  var item, _i, _len, _ref;
  this.sourceData = opts.source;
  this.sourceMap = {};
  _ref = this.sourceData;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    item = _ref[_i];
    this.sourceMap[item.value] = item.text;
  }
  return this.init('waybill', opts, Waybill.defaults);
};

$.fn.editableutils.inherit(Waybill, $.fn.editabletypes.abstractinput);

$.extend(Waybill.prototype, {
  render: function() {
    var fillItems;
    this.$input = this.$tpl.find('input');
    this.$list = this.$tpl.find('select');
    this.$list.empty();
    fillItems = function($el, data) {
      var item, _i, _len;
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        item = data[_i];
        $el.append($('<option>', {
          value: item.value
        }).text(item.text));
      }
      return $el;
    };
    return fillItems(this.$list, this.sourceData);
  },
  value2html: function(value, element) {
    if (!value) {
      return $(element).empty();
    }
    return $(element).html("" + value.parcel + "," + value.number);
  },
  html2value: function(html) {
    var number, parcel, _ref;
    _ref = html.split(','), parcel = _ref[0], number = _ref[1];
    return {
      parcel: parcel,
      number: number
    };
  },
  value2str: function(value) {
    return "" + value.parcel + "," + value.number;
  },
  str2value: function(str) {
    return str;
  },
  value2input: function(value) {
    var item, _i, _len, _ref;
    if (!value) {
      return;
    }
    _ref = this.sourceData;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      item = _ref[_i];
      if (item.text === value.parcel) {
        this.$list.val(item.value);
        break;
      }
    }
    return this.$input.filter('[name="number"]').val(value.number);
  },
  input2value: function() {
    return {
      parcel: this.sourceMap[this.$list.val()],
      number: this.$input.filter('[name="number"]').val()
    };
  },
  activate: function() {
    return this.$list.focus();
  },
  autosubmit: function() {
    return this.$input.keydown(function(e) {
      if (e.which === 13) {
        return $(this).closest('form').submit();
      }
    });
  }
});

Waybill.defaults = $.extend({}, $.fn.editabletypes.abstractinput.defaults, {
  tpl: '<div class="editable-waybill">\n  <label><select name="parcel"></select></label>\n  <label><input type="text" name="number"></label>\n</div>',
  inputclass: '',
  source: []
});

$.fn.editabletypes.waybill = Waybill;
